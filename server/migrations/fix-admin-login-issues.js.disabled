/**
 * ä¿®å¤ç®¡ç†å‘˜ç™»å½•ç›¸å…³çš„æ•°æ®åº“é—®é¢˜
 * 
 * é—®é¢˜1: admin_sessions è¡¨çš„ token å’Œ refreshToken å­—æ®µé•¿åº¦ä¸è¶³
 * é—®é¢˜2: admin_audit_logs è¡¨çš„ adminId å­—æ®µä¸å…è®¸ nullï¼Œä½†ç™»å½•å¤±è´¥æ—¶éœ€è¦è®°å½•åŒ¿åå®¡è®¡æ—¥å¿—
 */

const { QueryInterface, DataTypes } = require('sequelize');

module.exports = {
  up: async (queryInterface, Sequelize) => {
    console.log('ğŸ”§ å¼€å§‹ä¿®å¤ç®¡ç†å‘˜ç™»å½•ç›¸å…³æ•°æ®åº“é—®é¢˜...');
    
    try {
      // ä¿®å¤1: æ‰©å±• admin_sessions è¡¨çš„ token å­—æ®µé•¿åº¦
      console.log('ğŸ“ ä¿®å¤ admin_sessions è¡¨çš„ token å­—æ®µé•¿åº¦...');
      
      await queryInterface.changeColumn('admin_sessions', 'token', {
        type: DataTypes.TEXT,
        allowNull: false,
        unique: true
      });
      
      await queryInterface.changeColumn('admin_sessions', 'refreshToken', {
        type: DataTypes.TEXT,
        allowNull: true,
        unique: true
      });
      
      console.log('âœ… admin_sessions è¡¨å­—æ®µé•¿åº¦ä¿®å¤å®Œæˆ');
      
      // ä¿®å¤2: å…è®¸ admin_audit_logs è¡¨çš„ adminId å­—æ®µä¸º null
      console.log('ğŸ“ ä¿®å¤ admin_audit_logs è¡¨çš„ adminId çº¦æŸ...');
      
      await queryInterface.changeColumn('admin_audit_logs', 'adminId', {
        type: DataTypes.UUID,
        allowNull: true, // å…è®¸ä¸ºnullï¼Œæ”¯æŒåŒ¿åæ“ä½œå®¡è®¡
        references: {
          model: 'admins',
          key: 'id'
        }
      });
      
      console.log('âœ… admin_audit_logs è¡¨çº¦æŸä¿®å¤å®Œæˆ');
      
      console.log('ğŸ‰ æ‰€æœ‰ç®¡ç†å‘˜ç™»å½•ç›¸å…³é—®é¢˜ä¿®å¤å®Œæˆï¼');
      
    } catch (error) {
      console.error('âŒ æ•°æ®åº“è¿ç§»å¤±è´¥:', error);
      throw error;
    }
  },

  down: async (queryInterface, Sequelize) => {
    console.log('âª å›æ»šç®¡ç†å‘˜ç™»å½•ä¿®å¤...');
    
    try {
      // å›æ»š1: æ¢å¤ admin_sessions è¡¨çš„å­—æ®µç±»å‹
      await queryInterface.changeColumn('admin_sessions', 'token', {
        type: DataTypes.STRING,
        allowNull: false,
        unique: true
      });
      
      await queryInterface.changeColumn('admin_sessions', 'refreshToken', {
        type: DataTypes.STRING,
        allowNull: true,
        unique: true
      });
      
      // å›æ»š2: æ¢å¤ admin_audit_logs è¡¨çš„ adminId çº¦æŸ
      await queryInterface.changeColumn('admin_audit_logs', 'adminId', {
        type: DataTypes.UUID,
        allowNull: false,
        references: {
          model: 'admins',
          key: 'id'
        }
      });
      
      console.log('âœ… å›æ»šå®Œæˆ');
      
    } catch (error) {
      console.error('âŒ å›æ»šå¤±è´¥:', error);
      throw error;
    }
  }
}; 