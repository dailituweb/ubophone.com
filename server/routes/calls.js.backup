const express = require('express');
const { Call, User, CallRecording } = require('../models');
const auth = require('../middleware/auth');
const { client: twilioClient } = require('../config/twilio');

const router = express.Router();

// Comprehensive global rates based on Twilio's pricing with profit margins
const getGlobalRates = () => {
  return {
    // North America
    'US': { 
      mobile: 0.020, landline: 0.015, currency: 'USD', 
      name: 'United States', flag: 'ðŸ‡ºðŸ‡¸', region: 'North America' 
    },
    'CA': { 
      mobile: 0.020, landline: 0.015, currency: 'USD', 
      name: 'Canada', flag: 'ðŸ‡¨ðŸ‡¦', region: 'North America' 
    },
    'MX': { 
      mobile: 0.065, landline: 0.050, currency: 'USD', 
      name: 'Mexico', flag: 'ðŸ‡²ðŸ‡½', region: 'North America' 
    },
    'GT': { 
      mobile: 0.180, landline: 0.150, currency: 'USD', 
      name: 'Guatemala', flag: 'ðŸ‡¬ðŸ‡¹', region: 'North America' 
    },
    'BZ': { 
      mobile: 0.220, landline: 0.180, currency: 'USD', 
      name: 'Belize', flag: 'ðŸ‡§ðŸ‡¿', region: 'North America' 
    },
    'SV': { 
      mobile: 0.180, landline: 0.150, currency: 'USD', 
      name: 'El Salvador', flag: 'ðŸ‡¸ðŸ‡»', region: 'North America' 
    },
    'HN': { 
      mobile: 0.200, landline: 0.170, currency: 'USD', 
      name: 'Honduras', flag: 'ðŸ‡­ðŸ‡³', region: 'North America' 
    },
    'NI': { 
      mobile: 0.220, landline: 0.180, currency: 'USD', 
      name: 'Nicaragua', flag: 'ðŸ‡³ðŸ‡®', region: 'North America' 
    },
    'CR': { 
      mobile: 0.140, landline: 0.110, currency: 'USD', 
      name: 'Costa Rica', flag: 'ðŸ‡¨ðŸ‡·', region: 'North America' 
    },
    'PA': { 
      mobile: 0.120, landline: 0.100, currency: 'USD', 
      name: 'Panama', flag: 'ðŸ‡µðŸ‡¦', region: 'North America' 
    },
    'DO': { 
      mobile: 0.220, landline: 0.180, currency: 'USD', 
      name: 'Dominican Republic', flag: 'ðŸ‡©ðŸ‡´', region: 'North America' 
    },
    'HT': { 
      mobile: 0.350, landline: 0.280, currency: 'USD', 
      name: 'Haiti', flag: 'ðŸ‡­ðŸ‡¹', region: 'North America' 
    },
    'JM': { 
      mobile: 0.280, landline: 0.220, currency: 'USD', 
      name: 'Jamaica', flag: 'ðŸ‡¯ðŸ‡²', region: 'North America' 
    },
    'CU': { 
      mobile: 0.950, landline: 0.850, currency: 'USD', 
      name: 'Cuba', flag: 'ðŸ‡¨ðŸ‡º', region: 'North America' 
    },

    // South America
    'BR': { 
      mobile: 0.110, landline: 0.085, currency: 'USD', 
      name: 'Brazil', flag: 'ðŸ‡§ðŸ‡·', region: 'South America' 
    },
    'AR': { 
      mobile: 0.090, landline: 0.070, currency: 'USD', 
      name: 'Argentina', flag: 'ðŸ‡¦ðŸ‡·', region: 'South America' 
    },
    'CL': { 
      mobile: 0.080, landline: 0.065, currency: 'USD', 
      name: 'Chile', flag: 'ðŸ‡¨ðŸ‡±', region: 'South America' 
    },
    'CO': { 
      mobile: 0.065, landline: 0.050, currency: 'USD', 
      name: 'Colombia', flag: 'ðŸ‡¨ðŸ‡´', region: 'South America' 
    },
    'PE': { 
      mobile: 0.085, landline: 0.065, currency: 'USD', 
      name: 'Peru', flag: 'ðŸ‡µðŸ‡ª', region: 'South America' 
    },
    'VE': { 
      mobile: 0.150, landline: 0.120, currency: 'USD', 
      name: 'Venezuela', flag: 'ðŸ‡»ðŸ‡ª', region: 'South America' 
    },
    'EC': { 
      mobile: 0.180, landline: 0.150, currency: 'USD', 
      name: 'Ecuador', flag: 'ðŸ‡ªðŸ‡¨', region: 'South America' 
    },
    'BO': { 
      mobile: 0.220, landline: 0.180, currency: 'USD', 
      name: 'Bolivia', flag: 'ðŸ‡§ðŸ‡´', region: 'South America' 
    },
    'PY': { 
      mobile: 0.120, landline: 0.095, currency: 'USD', 
      name: 'Paraguay', flag: 'ðŸ‡µðŸ‡¾', region: 'South America' 
    },
    'UY': { 
      mobile: 0.140, landline: 0.110, currency: 'USD', 
      name: 'Uruguay', flag: 'ðŸ‡ºðŸ‡¾', region: 'South America' 
    },
    'GY': { 
      mobile: 0.350, landline: 0.280, currency: 'USD', 
      name: 'Guyana', flag: 'ðŸ‡¬ðŸ‡¾', region: 'South America' 
    },
    'SR': { 
      mobile: 0.380, landline: 0.300, currency: 'USD', 
      name: 'Suriname', flag: 'ðŸ‡¸ðŸ‡·', region: 'South America' 
    },

    // Europe
    'GB': { 
      mobile: 0.042, landline: 0.032, currency: 'USD', 
      name: 'United Kingdom', flag: 'ðŸ‡¬ðŸ‡§', region: 'Europe' 
    },
    'DE': { 
      mobile: 0.038, landline: 0.028, currency: 'USD', 
      name: 'Germany', flag: 'ðŸ‡©ðŸ‡ª', region: 'Europe' 
    },
    'FR': { 
      mobile: 0.040, landline: 0.030, currency: 'USD', 
      name: 'France', flag: 'ðŸ‡«ðŸ‡·', region: 'Europe' 
    },
    'IT': { 
      mobile: 0.045, landline: 0.035, currency: 'USD', 
      name: 'Italy', flag: 'ðŸ‡®ðŸ‡¹', region: 'Europe' 
    },
    'ES': { 
      mobile: 0.042, landline: 0.032, currency: 'USD', 
      name: 'Spain', flag: 'ðŸ‡ªðŸ‡¸', region: 'Europe' 
    },
    'NL': { 
      mobile: 0.038, landline: 0.028, currency: 'USD', 
      name: 'Netherlands', flag: 'ðŸ‡³ðŸ‡±', region: 'Europe' 
    },
    'BE': { 
      mobile: 0.040, landline: 0.030, currency: 'USD', 
      name: 'Belgium', flag: 'ðŸ‡§ðŸ‡ª', region: 'Europe' 
    },
    'CH': { 
      mobile: 0.035, landline: 0.025, currency: 'USD', 
      name: 'Switzerland', flag: 'ðŸ‡¨ðŸ‡­', region: 'Europe' 
    },
    'AT': { 
      mobile: 0.042, landline: 0.032, currency: 'USD', 
      name: 'Austria', flag: 'ðŸ‡¦ðŸ‡¹', region: 'Europe' 
    },
    'SE': { 
      mobile: 0.035, landline: 0.025, currency: 'USD', 
      name: 'Sweden', flag: 'ðŸ‡¸ðŸ‡ª', region: 'Europe' 
    },
    'NO': { 
      mobile: 0.038, landline: 0.028, currency: 'USD', 
      name: 'Norway', flag: 'ðŸ‡³ðŸ‡´', region: 'Europe' 
    },
    'DK': { 
      mobile: 0.035, landline: 0.025, currency: 'USD', 
      name: 'Denmark', flag: 'ðŸ‡©ðŸ‡°', region: 'Europe' 
    },
    'FI': { 
      mobile: 0.038, landline: 0.028, currency: 'USD', 
      name: 'Finland', flag: 'ðŸ‡«ðŸ‡®', region: 'Europe' 
    },
    'PL': { 
      mobile: 0.055, landline: 0.045, currency: 'USD', 
      name: 'Poland', flag: 'ðŸ‡µðŸ‡±', region: 'Europe' 
    },
    'CZ': { 
      mobile: 0.050, landline: 0.040, currency: 'USD', 
      name: 'Czech Republic', flag: 'ðŸ‡¨ðŸ‡¿', region: 'Europe' 
    },
    'HU': { 
      mobile: 0.055, landline: 0.045, currency: 'USD', 
      name: 'Hungary', flag: 'ðŸ‡­ðŸ‡º', region: 'Europe' 
    },
    'SK': { 
      mobile: 0.052, landline: 0.042, currency: 'USD', 
      name: 'Slovakia', flag: 'ðŸ‡¸ðŸ‡°', region: 'Europe' 
    },
    'SI': { 
      mobile: 0.050, landline: 0.040, currency: 'USD', 
      name: 'Slovenia', flag: 'ðŸ‡¸ðŸ‡®', region: 'Europe' 
    },
    'HR': { 
      mobile: 0.058, landline: 0.048, currency: 'USD', 
      name: 'Croatia', flag: 'ðŸ‡­ðŸ‡·', region: 'Europe' 
    },
    'RS': { 
      mobile: 0.095, landline: 0.075, currency: 'USD', 
      name: 'Serbia', flag: 'ðŸ‡·ðŸ‡¸', region: 'Europe' 
    },
    'BG': { 
      mobile: 0.085, landline: 0.065, currency: 'USD', 
      name: 'Bulgaria', flag: 'ðŸ‡§ðŸ‡¬', region: 'Europe' 
    },
    'RO': { 
      mobile: 0.065, landline: 0.050, currency: 'USD', 
      name: 'Romania', flag: 'ðŸ‡·ðŸ‡´', region: 'Europe' 
    },
    'GR': { 
      mobile: 0.068, landline: 0.052, currency: 'USD', 
      name: 'Greece', flag: 'ðŸ‡¬ðŸ‡·', region: 'Europe' 
    },
    'PT': { 
      mobile: 0.048, landline: 0.038, currency: 'USD', 
      name: 'Portugal', flag: 'ðŸ‡µðŸ‡¹', region: 'Europe' 
    },
    'IE': { 
      mobile: 0.042, landline: 0.032, currency: 'USD', 
      name: 'Ireland', flag: 'ðŸ‡®ðŸ‡ª', region: 'Europe' 
    },
    'LU': { 
      mobile: 0.045, landline: 0.035, currency: 'USD', 
      name: 'Luxembourg', flag: 'ðŸ‡±ðŸ‡º', region: 'Europe' 
    },
    'IS': { 
      mobile: 0.048, landline: 0.038, currency: 'USD', 
      name: 'Iceland', flag: 'ðŸ‡®ðŸ‡¸', region: 'Europe' 
    },
    'MT': { 
      mobile: 0.055, landline: 0.045, currency: 'USD', 
      name: 'Malta', flag: 'ðŸ‡²ðŸ‡¹', region: 'Europe' 
    },
    'CY': { 
      mobile: 0.058, landline: 0.048, currency: 'USD', 
      name: 'Cyprus', flag: 'ðŸ‡¨ðŸ‡¾', region: 'Europe' 
    },
    'EE': { 
      mobile: 0.065, landline: 0.050, currency: 'USD', 
      name: 'Estonia', flag: 'ðŸ‡ªðŸ‡ª', region: 'Europe' 
    },
    'LV': { 
      mobile: 0.068, landline: 0.052, currency: 'USD', 
      name: 'Latvia', flag: 'ðŸ‡±ðŸ‡»', region: 'Europe' 
    },
    'LT': { 
      mobile: 0.065, landline: 0.050, currency: 'USD', 
      name: 'Lithuania', flag: 'ðŸ‡±ðŸ‡¹', region: 'Europe' 
    },
    'RU': { 
      mobile: 0.110, landline: 0.085, currency: 'USD', 
      name: 'Russia', flag: 'ðŸ‡·ðŸ‡º', region: 'Europe' 
    },
    'UA': { 
      mobile: 0.150, landline: 0.120, currency: 'USD', 
      name: 'Ukraine', flag: 'ðŸ‡ºðŸ‡¦', region: 'Europe' 
    },
    'BY': { 
      mobile: 0.180, landline: 0.150, currency: 'USD', 
      name: 'Belarus', flag: 'ðŸ‡§ðŸ‡¾', region: 'Europe' 
    },
    'MD': { 
      mobile: 0.220, landline: 0.180, currency: 'USD', 
      name: 'Moldova', flag: 'ðŸ‡²ðŸ‡©', region: 'Europe' 
    },
    'TR': { 
      mobile: 0.078, landline: 0.060, currency: 'USD', 
      name: 'Turkey', flag: 'ðŸ‡¹ðŸ‡·', region: 'Europe' 
    },

    // Asia Pacific
    'JP': { 
      mobile: 0.065, landline: 0.050, currency: 'USD', 
      name: 'Japan', flag: 'ðŸ‡¯ðŸ‡µ', region: 'Asia Pacific' 
    },
    'CN': { 
      mobile: 0.078, landline: 0.060, currency: 'USD', 
      name: 'China', flag: 'ðŸ‡¨ðŸ‡³', region: 'Asia Pacific' 
    },
    'KR': { 
      mobile: 0.052, landline: 0.040, currency: 'USD', 
      name: 'South Korea', flag: 'ðŸ‡°ðŸ‡·', region: 'Asia Pacific' 
    },
    'SG': { 
      mobile: 0.052, landline: 0.040, currency: 'USD', 
      name: 'Singapore', flag: 'ðŸ‡¸ðŸ‡¬', region: 'Asia Pacific' 
    },
    'HK': { 
      mobile: 0.048, landline: 0.038, currency: 'USD', 
      name: 'Hong Kong', flag: 'ðŸ‡­ðŸ‡°', region: 'Asia Pacific' 
    },
    'TW': { 
      mobile: 0.058, landline: 0.045, currency: 'USD', 
      name: 'Taiwan', flag: 'ðŸ‡¹ðŸ‡¼', region: 'Asia Pacific' 
    },
    'MY': { 
      mobile: 0.078, landline: 0.060, currency: 'USD', 
      name: 'Malaysia', flag: 'ðŸ‡²ðŸ‡¾', region: 'Asia Pacific' 
    },
    'TH': { 
      mobile: 0.095, landline: 0.075, currency: 'USD', 
      name: 'Thailand', flag: 'ðŸ‡¹ðŸ‡­', region: 'Asia Pacific' 
    },
    'PH': { 
      mobile: 0.130, landline: 0.110, currency: 'USD', 
      name: 'Philippines', flag: 'ðŸ‡µðŸ‡­', region: 'Asia Pacific' 
    },
    'ID': { 
      mobile: 0.155, landline: 0.125, currency: 'USD', 
      name: 'Indonesia', flag: 'ðŸ‡®ðŸ‡©', region: 'Asia Pacific' 
    },
    'VN': { 
      mobile: 0.118, landline: 0.095, currency: 'USD', 
      name: 'Vietnam', flag: 'ðŸ‡»ðŸ‡³', region: 'Asia Pacific' 
    },
    'IN': { 
      mobile: 0.104, landline: 0.080, currency: 'USD', 
      name: 'India', flag: 'ðŸ‡®ðŸ‡³', region: 'Asia Pacific' 
    },
    'PK': { 
      mobile: 0.130, landline: 0.105, currency: 'USD', 
      name: 'Pakistan', flag: 'ðŸ‡µðŸ‡°', region: 'Asia Pacific' 
    },
    'BD': { 
      mobile: 0.078, landline: 0.065, currency: 'USD', 
      name: 'Bangladesh', flag: 'ðŸ‡§ðŸ‡©', region: 'Asia Pacific' 
    },
    'LK': { 
      mobile: 0.195, landline: 0.155, currency: 'USD', 
      name: 'Sri Lanka', flag: 'ðŸ‡±ðŸ‡°', region: 'Asia Pacific' 
    },
    'NP': { 
      mobile: 0.180, landline: 0.150, currency: 'USD', 
      name: 'Nepal', flag: 'ðŸ‡³ðŸ‡µ', region: 'Asia Pacific' 
    },
    'MM': { 
      mobile: 0.350, landline: 0.280, currency: 'USD', 
      name: 'Myanmar', flag: 'ðŸ‡²ðŸ‡²', region: 'Asia Pacific' 
    },
    'KH': { 
      mobile: 0.120, landline: 0.095, currency: 'USD', 
      name: 'Cambodia', flag: 'ðŸ‡°ðŸ‡­', region: 'Asia Pacific' 
    },
    'LA': { 
      mobile: 0.180, landline: 0.150, currency: 'USD', 
      name: 'Laos', flag: 'ðŸ‡±ðŸ‡¦', region: 'Asia Pacific' 
    },
    'MN': { 
      mobile: 0.085, landline: 0.068, currency: 'USD', 
      name: 'Mongolia', flag: 'ðŸ‡²ðŸ‡³', region: 'Asia Pacific' 
    },
    'BT': { 
      mobile: 0.195, landline: 0.155, currency: 'USD', 
      name: 'Bhutan', flag: 'ðŸ‡§ðŸ‡¹', region: 'Asia Pacific' 
    },
    'AU': { 
      mobile: 0.052, landline: 0.040, currency: 'USD', 
      name: 'Australia', flag: 'ðŸ‡¦ðŸ‡º', region: 'Asia Pacific' 
    },
    'NZ': { 
      mobile: 0.065, landline: 0.050, currency: 'USD', 
      name: 'New Zealand', flag: 'ðŸ‡³ðŸ‡¿', region: 'Asia Pacific' 
    },
    'FJ': { 
      mobile: 0.450, landline: 0.380, currency: 'USD', 
      name: 'Fiji', flag: 'ðŸ‡«ðŸ‡¯', region: 'Asia Pacific' 
    },
    'PG': { 
      mobile: 0.950, landline: 0.780, currency: 'USD', 
      name: 'Papua New Guinea', flag: 'ðŸ‡µðŸ‡¬', region: 'Asia Pacific' 
    },

    // Middle East
    'IL': { 
      mobile: 0.052, landline: 0.040, currency: 'USD', 
      name: 'Israel', flag: 'ðŸ‡®ðŸ‡±', region: 'Middle East' 
    },
    'AE': { 
      mobile: 0.065, landline: 0.050, currency: 'USD', 
      name: 'United Arab Emirates', flag: 'ðŸ‡¦ðŸ‡ª', region: 'Middle East' 
    },
    'SA': { 
      mobile: 0.078, landline: 0.060, currency: 'USD', 
      name: 'Saudi Arabia', flag: 'ðŸ‡¸ðŸ‡¦', region: 'Middle East' 
    },
    'QA': { 
      mobile: 0.195, landline: 0.155, currency: 'USD', 
      name: 'Qatar', flag: 'ðŸ‡¶ðŸ‡¦', region: 'Middle East' 
    },
    'KW': { 
      mobile: 0.120, landline: 0.095, currency: 'USD', 
      name: 'Kuwait', flag: 'ðŸ‡°ðŸ‡¼', region: 'Middle East' 
    },
    'BH': { 
      mobile: 0.140, landline: 0.110, currency: 'USD', 
      name: 'Bahrain', flag: 'ðŸ‡§ðŸ‡­', region: 'Middle East' 
    },
    'OM': { 
      mobile: 0.220, landline: 0.180, currency: 'USD', 
      name: 'Oman', flag: 'ðŸ‡´ðŸ‡²', region: 'Middle East' 
    },
    'JO': { 
      mobile: 0.280, landline: 0.220, currency: 'USD', 
      name: 'Jordan', flag: 'ðŸ‡¯ðŸ‡´', region: 'Middle East' 
    },
    'LB': { 
      mobile: 0.195, landline: 0.155, currency: 'USD', 
      name: 'Lebanon', flag: 'ðŸ‡±ðŸ‡§', region: 'Middle East' 
    },
    'SY': { 
      mobile: 0.450, landline: 0.380, currency: 'USD', 
      name: 'Syria', flag: 'ðŸ‡¸ðŸ‡¾', region: 'Middle East' 
    },
    'IQ': { 
      mobile: 0.380, landline: 0.320, currency: 'USD', 
      name: 'Iraq', flag: 'ðŸ‡®ðŸ‡¶', region: 'Middle East' 
    },
    'IR': { 
      mobile: 0.280, landline: 0.220, currency: 'USD', 
      name: 'Iran', flag: 'ðŸ‡®ðŸ‡·', region: 'Middle East' 
    },
    'AF': { 
      mobile: 0.320, landline: 0.260, currency: 'USD', 
      name: 'Afghanistan', flag: 'ðŸ‡¦ðŸ‡«', region: 'Middle East' 
    },
    'YE': { 
      mobile: 0.280, landline: 0.220, currency: 'USD', 
      name: 'Yemen', flag: 'ðŸ‡¾ðŸ‡ª', region: 'Middle East' 
    },

    // Africa
    'ZA': { 
      mobile: 0.104, landline: 0.080, currency: 'USD', 
      name: 'South Africa', flag: 'ðŸ‡¿ðŸ‡¦', region: 'Africa' 
    },
    'EG': { 
      mobile: 0.195, landline: 0.155, currency: 'USD', 
      name: 'Egypt', flag: 'ðŸ‡ªðŸ‡¬', region: 'Africa' 
    },
    'NG': { 
      mobile: 0.215, landline: 0.175, currency: 'USD', 
      name: 'Nigeria', flag: 'ðŸ‡³ðŸ‡¬', region: 'Africa' 
    },
    'KE': { 
      mobile: 0.182, landline: 0.150, currency: 'USD', 
      name: 'Kenya', flag: 'ðŸ‡°ðŸ‡ª', region: 'Africa' 
    },
    'GH': { 
      mobile: 0.195, landline: 0.155, currency: 'USD', 
      name: 'Ghana', flag: 'ðŸ‡¬ðŸ‡­', region: 'Africa' 
    },
    'UG': { 
      mobile: 0.320, landline: 0.260, currency: 'USD', 
      name: 'Uganda', flag: 'ðŸ‡ºðŸ‡¬', region: 'Africa' 
    },
    'TZ': { 
      mobile: 0.380, landline: 0.320, currency: 'USD', 
      name: 'Tanzania', flag: 'ðŸ‡¹ðŸ‡¿', region: 'Africa' 
    },
    'RW': { 
      mobile: 0.420, landline: 0.350, currency: 'USD', 
      name: 'Rwanda', flag: 'ðŸ‡·ðŸ‡¼', region: 'Africa' 
    },
    'ET': { 
      mobile: 0.350, landline: 0.280, currency: 'USD', 
      name: 'Ethiopia', flag: 'ðŸ‡ªðŸ‡¹', region: 'Africa' 
    },
    'MA': { 
      mobile: 0.650, landline: 0.520, currency: 'USD', 
      name: 'Morocco', flag: 'ðŸ‡²ðŸ‡¦', region: 'Africa' 
    },
    'TN': { 
      mobile: 0.780, landline: 0.620, currency: 'USD', 
      name: 'Tunisia', flag: 'ðŸ‡¹ðŸ‡³', region: 'Africa' 
    },
    'DZ': { 
      mobile: 0.580, landline: 0.480, currency: 'USD', 
      name: 'Algeria', flag: 'ðŸ‡©ðŸ‡¿', region: 'Africa' 
    },
    'LY': { 
      mobile: 0.450, landline: 0.380, currency: 'USD', 
      name: 'Libya', flag: 'ðŸ‡±ðŸ‡¾', region: 'Africa' 
    },
    'SD': { 
      mobile: 0.280, landline: 0.220, currency: 'USD', 
      name: 'Sudan', flag: 'ðŸ‡¸ðŸ‡©', region: 'Africa' 
    },
    'ZW': { 
      mobile: 0.520, landline: 0.420, currency: 'USD', 
      name: 'Zimbabwe', flag: 'ðŸ‡¿ðŸ‡¼', region: 'Africa' 
    },
    'ZM': { 
      mobile: 0.420, landline: 0.350, currency: 'USD', 
      name: 'Zambia', flag: 'ðŸ‡¿ðŸ‡²', region: 'Africa' 
    },
    'MW': { 
      mobile: 0.380, landline: 0.320, currency: 'USD', 
      name: 'Malawi', flag: 'ðŸ‡²ðŸ‡¼', region: 'Africa' 
    },
    'MZ': { 
      mobile: 0.320, landline: 0.260, currency: 'USD', 
      name: 'Mozambique', flag: 'ðŸ‡²ðŸ‡¿', region: 'Africa' 
    },
    'BW': { 
      mobile: 0.280, landline: 0.220, currency: 'USD', 
      name: 'Botswana', flag: 'ðŸ‡§ðŸ‡¼', region: 'Africa' 
    },
    'NA': { 
      mobile: 0.180, landline: 0.150, currency: 'USD', 
      name: 'Namibia', flag: 'ðŸ‡³ðŸ‡¦', region: 'Africa' 
    },
    'SZ': { 
      mobile: 0.220, landline: 0.180, currency: 'USD', 
      name: 'Eswatini', flag: 'ðŸ‡¸ðŸ‡¿', region: 'Africa' 
    },
    'LS': { 
      mobile: 0.380, landline: 0.320, currency: 'USD', 
      name: 'Lesotho', flag: 'ðŸ‡±ðŸ‡¸', region: 'Africa' 
    },
    'MG': { 
      mobile: 0.950, landline: 0.780, currency: 'USD', 
      name: 'Madagascar', flag: 'ðŸ‡²ðŸ‡¬', region: 'Africa' 
    },
    'MU': { 
      mobile: 0.180, landline: 0.150, currency: 'USD', 
      name: 'Mauritius', flag: 'ðŸ‡²ðŸ‡º', region: 'Africa' 
    },
    'SC': { 
      mobile: 0.650, landline: 0.520, currency: 'USD', 
      name: 'Seychelles', flag: 'ðŸ‡¸ðŸ‡¨', region: 'Africa' 
    },
    'SN': { 
      mobile: 0.520, landline: 0.420, currency: 'USD', 
      name: 'Senegal', flag: 'ðŸ‡¸ðŸ‡³', region: 'Africa' 
    },
    'CI': { 
      mobile: 0.320, landline: 0.260, currency: 'USD', 
      name: 'Ivory Coast', flag: 'ðŸ‡¨ðŸ‡®', region: 'Africa' 
    },
    'ML': { 
      mobile: 0.420, landline: 0.350, currency: 'USD', 
      name: 'Mali', flag: 'ðŸ‡²ðŸ‡±', region: 'Africa' 
    },
    'BF': { 
      mobile: 0.380, landline: 0.320, currency: 'USD', 
      name: 'Burkina Faso', flag: 'ðŸ‡§ðŸ‡«', region: 'Africa' 
    },
    'NE': { 
      mobile: 0.520, landline: 0.420, currency: 'USD', 
      name: 'Niger', flag: 'ðŸ‡³ðŸ‡ª', region: 'Africa' 
    },
    'TD': { 
      mobile: 0.650, landline: 0.520, currency: 'USD', 
      name: 'Chad', flag: 'ðŸ‡¹ðŸ‡©', region: 'Africa' 
    },
    'CM': { 
      mobile: 0.280, landline: 0.220, currency: 'USD', 
      name: 'Cameroon', flag: 'ðŸ‡¨ðŸ‡²', region: 'Africa' 
    },
    'GA': { 
      mobile: 0.380, landline: 0.320, currency: 'USD', 
      name: 'Gabon', flag: 'ðŸ‡¬ðŸ‡¦', region: 'Africa' 
    },
    'CG': { 
      mobile: 0.420, landline: 0.350, currency: 'USD', 
      name: 'Republic of the Congo', flag: 'ðŸ‡¨ðŸ‡¬', region: 'Africa' 
    },
    'CD': { 
      mobile: 0.520, landline: 0.420, currency: 'USD', 
      name: 'Democratic Republic of the Congo', flag: 'ðŸ‡¨ðŸ‡©', region: 'Africa' 
    },
    'CF': { 
      mobile: 0.650, landline: 0.520, currency: 'USD', 
      name: 'Central African Republic', flag: 'ðŸ‡¨ðŸ‡«', region: 'Africa' 
    },
    'AO': { 
      mobile: 0.220, landline: 0.180, currency: 'USD', 
      name: 'Angola', flag: 'ðŸ‡¦ðŸ‡´', region: 'Africa' 
    }
  };
};

// Get call rates for different countries
router.get('/rates', async (req, res) => {
  try {
    const rates = getGlobalRates();
    res.json(rates);
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: 'Server error' });
  }
});

// Initiate a call
router.post('/initiate', auth, async (req, res) => {
  try {
    const { to, from } = req.body;
    const user = await User.findByPk(req.user.userId);

    if (!user) {
      return res.status(404).json({ message: 'User not found' });
    }

    // Check if user has sufficient balance (minimum $1)
    if (user.balance < 1) {
      return res.status(400).json({ 
        message: 'Insufficient balance. Please add credits.' 
      });
    }

    // Create a new call record
    const call = await Call.create({
      userId: req.user.userId,
      callSid: `CA${Date.now()}${Math.random().toString(36).substr(2, 9)}`, // ä¸´æ—¶ç”Ÿæˆ
      fromNumber: from || '+1234567890',
      toNumber: to,
      direction: 'outbound',
      status: 'initiated',
      rate: 0.02,
      startTime: new Date()
    });

    // In a real implementation, you would integrate with Twilio or other VoIP service
    // For demo purposes, we'll simulate the call initiation
    res.json({
      success: true,
      callId: call.id,
      message: 'Call initiated successfully',
      estimatedRate: 0.02 // USD per minute
    });

  } catch (error) {
    console.error(error);
    res.status(500).json({ message: 'Server error' });
  }
});

// End a call
router.post('/end/:callId', auth, async (req, res) => {
  try {
    const call = await Call.findByPk(req.params.callId);
    
    if (!call || call.userId !== req.user.userId) {
      return res.status(404).json({ message: 'Call not found' });
    }

    const endTime = new Date();
    const duration = Math.ceil((endTime - call.startTime) / 1000); // seconds
    const cost = (duration / 60) * 0.02; // $0.02 per minute

    await call.update({
      endTime: endTime,
      duration: duration,
      cost: cost,
      status: 'completed'
    });

    // Deduct cost from user balance
    const user = await User.findByPk(req.user.userId);
    await user.update({
      balance: Math.max(0, parseFloat(user.balance) - cost)
    });

    res.json({
      success: true,
      duration: duration,
      cost: cost,
      remainingBalance: user.balance
    });

  } catch (error) {
    console.error(error);
    res.status(500).json({ message: 'Server error' });
  }
});

// Get call history
router.get('/history', auth, async (req, res) => {
  try {
    const page = parseInt(req.query.page) || 1;
    const limit = parseInt(req.query.limit) || 10;
    const offset = (page - 1) * limit;

    const { count: total, rows: calls } = await Call.findAndCountAll({
      where: { userId: req.user.userId },
      order: [['startTime', 'DESC']],
      offset: offset,
      limit: limit,
      include: [
        {
          model: CallRecording,
          as: 'recording',
          required: false
        }
      ]
    });

    res.json({
      calls,
      pagination: {
        page,
        limit,
        total,
        pages: Math.ceil(total / limit)
      }
    });

  } catch (error) {
    console.error(error);
    res.status(500).json({ message: 'Server error' });
  }
});

// è´¹çŽ‡è®¡ç®—å™¨ - è®¡ç®—é€šè¯è´¹ç”¨ï¼ˆæ”¯æŒç§»åŠ¨å’Œå›ºè¯è´¹çŽ‡ï¼‰
router.post('/calculate', async (req, res) => {
  try {
    const { country, duration, unit = 'minutes', callType = 'mobile' } = req.body;
    
    if (!country || !duration) {
      return res.status(400).json({ 
        message: 'Country and duration are required' 
      });
    }

    // èŽ·å–è´¹çŽ‡æ•°æ®
    const rates = getGlobalRates();

    const countryRate = rates[country.toUpperCase()];
    if (!countryRate) {
      return res.status(404).json({ 
        message: 'Country not found' 
      });
    }

    // æ ¹æ®é€šè¯ç±»åž‹èŽ·å–ç›¸åº”è´¹çŽ‡
    const rate = callType === 'landline' ? countryRate.landline : countryRate.mobile;

    // è½¬æ¢æ—¶é•¿ä¸ºåˆ†é’Ÿ
    let durationInMinutes = parseFloat(duration);
    if (unit === 'seconds') {
      durationInMinutes = durationInMinutes / 60;
    } else if (unit === 'hours') {
      durationInMinutes = durationInMinutes * 60;
    }

    // è®¡ç®—è´¹ç”¨ï¼ˆå‘ä¸Šå–æ•´åˆ°åˆ†é’Ÿï¼‰
    const roundedMinutes = Math.ceil(durationInMinutes);
    const totalCost = roundedMinutes * rate;

    // è®¡ç®—èŠ‚çœï¼ˆå¦‚æžœé€‰æ‹©å›ºè¯ï¼‰
    const mobileRate = countryRate.mobile;
    const landlineRate = countryRate.landline;
    const savingsPercent = ((mobileRate - landlineRate) / mobileRate * 100).toFixed(1);
    const savingsAmount = roundedMinutes * (mobileRate - landlineRate);

    // è®¡ç®—å„ç§ç»Ÿè®¡ä¿¡æ¯
    const costBreakdown = {
      country: countryRate.name,
      flag: countryRate.flag,
      region: countryRate.region,
      callType: callType,
      rates: {
        mobile: mobileRate,
        landline: landlineRate,
        current: rate
      },
      currency: countryRate.currency,
      duration: {
        input: duration,
        unit: unit,
        minutes: durationInMinutes,
        billableMinutes: roundedMinutes
      },
      cost: {
        total: parseFloat(totalCost.toFixed(4)),
        perMinute: rate,
        formatted: `$${totalCost.toFixed(4)}`
      },
      savings: {
        percent: savingsPercent,
        amount: parseFloat(savingsAmount.toFixed(4)),
        formatted: `$${savingsAmount.toFixed(4)}`,
        applicable: callType === 'landline' && mobileRate > landlineRate
      },
      comparison: {
        // ä¸Žæœ€ä¾¿å®œå›½å®¶æ¯”è¾ƒ
        cheapest: rates['US'].mobile,
        difference: `${(((rate - rates['US'].mobile) / rates['US'].mobile) * 100).toFixed(1)}%`,
        // ä¸Žæœ€è´µå›½å®¶æ¯”è¾ƒ  
        expensive: Math.max(...Object.values(rates).map(r => r.mobile)),
        discount: `${(((Math.max(...Object.values(rates).map(r => r.mobile)) - rate) / Math.max(...Object.values(rates).map(r => r.mobile)) * 100).toFixed(1)}%`
      }
    };

    res.json({
      success: true,
      calculation: costBreakdown
    });

  } catch (error) {
    console.error(error);
    res.status(500).json({ message: 'Server error' });
  }
});

// è´¹çŽ‡æ¯”è¾ƒå™¨ - æ¯”è¾ƒå¤šä¸ªå›½å®¶è´¹çŽ‡ï¼ˆæ”¯æŒç§»åŠ¨å’Œå›ºè¯è´¹çŽ‡ï¼‰
router.post('/compare', async (req, res) => {
  try {
    const { countries, duration = 10, callType = 'mobile' } = req.body; // é»˜è®¤10åˆ†é’Ÿ

    if (!countries || !Array.isArray(countries) || countries.length === 0) {
      return res.status(400).json({ 
        message: 'Countries array is required' 
      });
    }

    // èŽ·å–è´¹çŽ‡æ•°æ®
    const rates = getGlobalRates();

    const comparisons = [];
    
    for (const country of countries) {
      const countryRate = rates[country.toUpperCase()];
      if (countryRate) {
        const rate = callType === 'landline' ? countryRate.landline : countryRate.mobile;
        const cost = duration * rate;
        const mobileRate = countryRate.mobile;
        const landlineRate = countryRate.landline;
        const savingsPercent = ((mobileRate - landlineRate) / mobileRate * 100).toFixed(1);
        
        comparisons.push({
          country: country.toUpperCase(),
          name: countryRate.name,
          flag: countryRate.flag,
          region: countryRate.region,
          callType: callType,
          rates: {
            mobile: mobileRate,
            landline: landlineRate,
            current: rate
          },
          cost: parseFloat(cost.toFixed(4)),
          formatted: `$${cost.toFixed(4)}`,
          savings: {
            percent: savingsPercent,
            amount: parseFloat((duration * (mobileRate - landlineRate)).toFixed(4)),
            applicable: mobileRate > landlineRate
          }
        });
      }
    }

    // æŒ‰è´¹ç”¨æŽ’åº
    comparisons.sort((a, b) => a.cost - b.cost);

    // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
    const costs = comparisons.map(c => c.cost);
    const stats = {
      cheapest: Math.min(...costs),
      expensive: Math.max(...costs),
      average: costs.reduce((a, b) => a + b, 0) / costs.length,
      duration: duration,
      callType: callType,
      totalCountries: comparisons.length
    };

    res.json({
      success: true,
      comparisons,
      stats: {
        ...stats,
        average: parseFloat(stats.average.toFixed(4)),
        cheapest: parseFloat(stats.cheapest.toFixed(4)),
        expensive: parseFloat(stats.expensive.toFixed(4))
      }
    });

  } catch (error) {
    console.error(error);
    res.status(500).json({ message: 'Server error' });
  }
});

module.exports = router; 